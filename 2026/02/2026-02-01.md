## 1. SQSとは？（基本概念）

**「システム間のメッセージを一時的に預かるバッファ（緩衝材）」**です。
システム同士の結合を弱める**「疎結合 (Decoupling)」**を実現するために使用します。

### 🍔 初学者向けイメージ：人気レストラン
* **Webサーバー** = **ホールスタッフ**（注文を受ける）
* **SQS** = **注文伝票を入れる箱**（一時預かり）
* **処理サーバー** = **シェフ**（料理を作る）

**メリット:**
ホールスタッフ（Webサーバー）は、シェフ（処理サーバー）の調理完了を待つことなく、伝票を箱に入れるだけで次の接客に移れます。シェフは自分のペースで箱から伝票を取り出せます。

---

## 2. 処理の基本フロー（重要）

1.  **送信 (Produce):** 送信側がメッセージをSQSに入れる。
2.  **受信 (Consume):** 受信側がSQSからメッセージを取得（ポーリング）する。
3.  **処理:** 受信側が実際の処理（画像変換など）を行う。
4.  **削除 (Delete):** **【重要】処理完了後、受信側が明示的にメッセージを削除する。**
    * *注意:* 削除しないと、処理失敗とみなされて再送されてしまいます。

---

## 3. 標準キュー vs FIFOキュー（試験の最頻出）

要件に応じてどちらを選ぶかが問われます。

| 特徴 | 標準キュー (Standard) | FIFOキュー (First-In-First-Out) |
| :--- | :--- | :--- |
| **順序** | **保証されない** (順不同の可能性あり) | **完全保証** (入れた順に出る) |
| **重複** | **稀に重複する** (At-least-once) | **重複なし** (Exactly-once) |
| **スループット** | **無制限** (超高速) | 制限あり (300件/秒など) |
| **用途** | とにかく大量処理、画像生成、ログ | 銀行取引、在庫管理、チケット販売 |
| **名前** | 自由 | 末尾が必ず `.fifo` |

> **試験のコツ:**
> * 「順序が重要」「重複NG」 → **FIFO**
> * 「スループット優先」「順序は問わない」 → **標準**

---

## 4. 絶対に覚えるべき3つの重要機能

試験でトラブルシューティング問題としてよく出題されます。

### ① 可視性タイムアウト (Visibility Timeout)
* **概要:** 受信側が処理している間、**他のサーバーからそのメッセージを見えなくするロック期間**。
* **デフォルト:** 30秒。
* **トラブル:** 処理時間がタイムアウトより長いと、ロックが外れて別のサーバーが同じメッセージを取得してしまい、**二重処理**が発生する。
* **対策:** 処理にかかる時間よりも長く設定する。

### ② ロングポーリング vs ショートポーリング
* **ショートポーリング:** メッセージがなくても即座に「空」の応答を返す（無駄な通信・コスト増）。
* **ロングポーリング (推奨):** メッセージが空の場合、**最大20秒間その場で待機**する。
    * **メリット:** APIコール数を減らし、**コスト削減**になる。メッセージ到着時の反応も速い。
    * **キーワード:** 「コスト最適化」「空のレスポンスを減らす」。

### ③ デッドレターキュー (DLQ)
* **概要:** 何度処理してもエラーになる「毒メッセージ」を隔離する特別なキュー。
* **目的:** エラーメッセージが無限ループして処理全体が詰まるのを防ぐ。
* **設定:** 「最大受信回数 (例: 5回)」を超えたらDLQへ移動させる。

---

## 5. その他の暗記項目（Facts）

* **メッセージ保持期間:** デフォルト4日（最大14日）。
* **メッセージサイズ:** 最大256KB（これを超える場合はS3に実データを置き、パスだけSQSに送る）。
* **遅延キュー (Delay Queue):** メッセージ送信後、指定時間（例: 10分）が経過するまで誰にも見せない機能。

---

## 6. SAA試験の勝ちパターン（解法フロー）

問題文を読んだ際、以下のロジックで正解を導き出せます。

1.  **「疎結合にしたい」「処理を非同期にしたい」**
    * → **SQS** を選択。
2.  **「順序を守る必要がある」「重複してはいけない」**
    * → **FIFOキュー** を選択。
3.  **「処理中に他のインスタンスも同じメッセージを受け取ってしまう」**
    * → **可視性タイムアウト** の時間を延長する。
4.  **「SQSのコストを下げたい」「空の受信が多い」**
    * → **ロングポーリング** を有効化する。
5.  **「SQSのメッセージ数に応じて処理サーバーを増やしたい」**
    * → **Auto Scaling** (トリガー: `ApproximateNumberOfMessagesVisible`)。