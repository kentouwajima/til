## 1. IAMの基本概念：3つの主役とルール

IAMは、**「誰（プリンシパル）」**が**「どのリソース」**に対して**「どんな操作」**をしてよいかを管理するサービスです。
※ IAM自体は**グローバルサービス**です（リージョンごとの作成は不要）。

### ① IAMユーザー (User)
* **「特定の人」や「アプリ」**のための永続的なID。
* 認証情報として「パスワード（コンソール用）」や「アクセスキー（CLI/プログラム用）」を持つ。
* **鉄則:** 1人に1ユーザー。共有してはいけない。

### ② IAMグループ (Group)
* ユーザーをまとめる箱（例: `Developers`, `Admins`）。
* **鉄則:** ポリシー（権限）はユーザーに直接付けず、**グループに付けて管理**する（運用負荷軽減のため）。

### ③ IAMロール (Role) → 【試験最重要】
* **「一時的な権限」**を渡すための帽子のようなもの。
* 特定のパスワードやキーを持たない。
* **誰がかぶるのか？（Principal）:**
    1.  **AWSサービス:** EC2, Lambda, ECSなどが他のサービス(S3など)を操作するとき。
    2.  **他アカウントのユーザー:** クロスアカウントアクセスのとき。
    3.  **外部ID:** Googleログインや社内Active Directory (SAML) 連携のとき。

### ④ IAMポリシー (Policy)
* 権限の内容を書いたドキュメント（JSON形式）。
* **構造:**
    * `Effect`: Allow（許可） or Deny（拒否）
    * `Action`: 何ができるか（例: `s3:ListBucket`）
    * `Resource`: 対象は何か（例: 特定のS3バケット）

---

## 2. 試験に出る「認証情報」のベストプラクティス

試験では「セキュリティ的に正しい設計」が問われます。

| 項目 | 内容 | 試験での判断基準 |
| :--- | :--- | :--- |
| **ルートユーザー** | アカウント作成時の最強権限ユーザー。 | **日常的に使わない。** MFA（多要素認証）を必ず有効化する。アクセスキーを作らない。 |
| **アクセスキー** | プログラム用ID/Pass (Access Key ID / Secret Access Key)。 | **コードに埋め込まない（ハードコーディング禁止）。** Gitに上げない。ローカルPCなら環境変数か`~/.aws/credentials`を使う。 |
| **IAMロール** | 一時的なクレデンシャル。 | **EC2やLambdaには必ずこれを使う。** アクセスキーを置いてはいけない。 |
| **MFA (多要素認証)** | パスワード + ワンタイムトークン。 | ルートユーザーや特権ユーザーには**必須**とする。 |
| **最小権限の原則** | Least Privilege。 | 最初は何も権限を与えず、**必要なものだけ**を許可する。 |

---

## 3. 頻出アーキテクチャパターン

SAA試験で「どのIAM機能を使うべきか？」と聞かれたら、このパターンを思い出してください。

### シナリオA：EC2からS3の画像を読み込みたい
**【NG】** EC2の中にアクセスキーとシークレットキーを保存する。
**【OK】** EC2に**IAMロール**をアタッチする。
* 理由: IAMロールを使えば、AWSが一時的なキーを自動でローテーションして管理してくれるため、漏洩リスクがない。

### シナリオB：別のアカウント(Dev)から本番環境(Prod)のS3を見たい
**【機能】** **クロスアカウントアクセス (Switch Role / Assume Role)**
1.  Prodアカウントで「Devアカウントからのアクセスを許可する信頼ポリシー」を持った**IAMロール**を作る。
2.  Devアカウントのユーザーが、そのロールにスイッチ（AssumeRole）する。
3.  一時的にProd環境の権限を得る。

### シナリオC：社内のActive Directory(AD)アカウントでAWSに入りたい
**【機能】** **IDフェデレーション (SAML連携)**
* 社員一人ひとりにIAMユーザーを作ると管理が大変（退職時の削除漏れなど）。
* **SAML 2.0** を使って社内ADと連携し、AWS側では**IAMロール**にマッピングする。
* これにより「シングルサインオン (SSO)」が可能になる。

### シナリオD：モバイルアプリのユーザー（数万人）にS3への直接アップロードを許可したい
**【機能】** **Web IDフェデレーション (Cognito)**
* Google, Facebook, Amazonなどのログイン情報を使い、Cognito経由で一時的なAWS認証情報を渡す。
* **IAMユーザーは作らない**（数万人分作るのは不可能）。

---

## 4. ポリシーの種類と評価ロジック

### ポリシーのタイプ
1.  **IDベースのポリシー:** ユーザー、グループ、ロールにアタッチする（「私が何をしていいか」）。
2.  **リソースベースのポリシー:** S3バケットやSQSキューなどに直接書く（「誰が私を触っていいか」）。
    * 代表例: **S3バケットポリシー**（特定のIP制限やクロスアカウント許可によく使う）。

### 評価ロジック（優先順位）
1.  **明示的な拒否 (Explicit Deny):** ポリシーに `Deny` が書いてあったら、他で許可されていても**絶対に拒否**。最強。
2.  **明示的な許可 (Explicit Allow):** `Allow` があれば許可。
3.  **暗黙の拒否 (Implicit Deny):** 何も書いていなければ、デフォルトは拒否。

> **試験のコツ:** 「特定のユーザー以外はアクセスさせない」という要件で、「`Deny`ポリシー」が出てきたらそれが正解候補。

---

## 5. 高度な管理（Organizations & SCP）

複数のAWSアカウントを管理する場合（AWS Organizations）の話です。

* **SCP (Service Control Policy):**
    * アカウント全体にかけるガードレール。
    * IAMポリシーで「S3フルアクセス」を持っていても、SCPで「S3禁止」とされていたら**何もできない**。
    * **用途:** 「特定のリージョン以外は使用禁止」「Redshiftの使用禁止」など、組織全体のルール強制に使う。
    * **注意:** SCPは権限を「与える」ものではなく「制限する」もの。

---

## 6. SAA試験直前チェックリスト

* [ ] **EC2にアクセスキーを埋め込む** という選択肢は即座に除外できるか？（正解はIAMロール）
* [ ] **ルートユーザー** は日常使いせず、MFAを設定しているか？
* [ ] **IAMユーザー** と **IAMロール** の使い分け（永続的な人 vs 一時的な権限）ができているか？
* [ ] **クロスアカウント** と言われたら `AssumeRole` (IAMロール) が浮かぶか？
* [ ] **JSONポリシー** を見て、`Allow`/`Deny` と `Resource` の関係が読めるか？

---

## 付録：IAMポリシーのJSON例

S3バケット(`example-bucket`)内のオブジェクト取得(`GetObject`)のみを許可する例。

```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Action": "s3:GetObject",
      "Resource": "arn:aws:s3:::example-bucket/*"
    }
  ]
}