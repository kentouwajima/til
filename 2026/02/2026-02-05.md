# 📝 構成管理手法の比較：Userdata vs Ansible

WordPress環境を構築する際、サーバー内部の設定（ミドルウェアのインストールなど）を行う手法として、本プロジェクトで採用した **Userdata** と、構成管理ツールの代表格である **Ansible** の違いをまとめます。

---

## 1. 比較概要

| 比較項目 | Userdata (Shell Script) | Ansible |
| :--- | :--- | :--- |
| **分類** | プロビジョニング（初期化） | 構成管理（Configuration Management） |
| **実行タイミング** | **インスタンスの初回起動時のみ** | **任意のタイミング**で何度でも実行可能 |
| **実行方式** | プル型（EC2が自ら取得して実行） | プッシュ型（管理端末から指示を送信） |
| **冪等性 (※1)** | **なし**（スクリプトを再度流すと不整合が起きやすい） | **あり**（あるべき状態を維持する仕組みがある） |
| **主な用途** | 簡易な設定、Immutable Infrastructure | 継続的な運用、複雑なクラスタ管理 |

> **(※1) 冪等性（べきとうせい）とは？**
> 「ある操作を何回行っても、結果が常に同じ（あるべき状態）になる」という性質のこと。

---

## 2. Userdata (Shell Script)
Terraformの `user_data` 属性を使用して、EC2の起動プロセス中にスクリプトを実行させます。

### 📌 特徴
* **シンプルかつ軽量**: 外部ツールを必要とせず、Terraform単体で完結します。
* **Immutable (不変) インフラ向け**: サーバーの設定変更が必要になった場合、古いサーバーを修正するのではなく、「新しいUserdataを持つサーバーを作成し、古い方は破棄する」という運用に向いています。

### ⚠️ 弱点
* **デバッグが困難**: スクリプトが途中で失敗してもTerraformは「成功」として完了してしまいます。ログはEC2内部（`/var/log/user-data.log`）を直接確認する必要があります。
* **一度きりの実行**: インストール後に設定を変えたい場合、Userdataを書き換えても既存のサーバーには反映されません。

---

## 3. Ansible
YAML形式の定義ファイル（Playbook）に基づき、SSH経由でサーバーの状態を管理します。

### 📌 特徴
* **高機能な構成管理**: 「Apacheをインストールする」「設定ファイルを書き換える」といった一連の流れを、エラーハンドリングを含めて安全に実行できます。
* **ドリフト（状態の乖離）対策**: 誰かが手動でサーバーの設定を変えてしまっても、Ansibleを再実行すれば元の「正しい状態」に強制的に戻すことができます。

### ⚠️ 弱点
* **セットアップの手間**: 管理端末へのインストールや、SSH疎通のためのインベントリ（管理対象リスト）の作成が必要です。
* **初期速度**: インスタンスが起動した**後**に実行するため、Webサーバーとして利用可能になるまでに一歩多く手順が必要です。

---

## 4. 判断基準：どちらを採用すべきか



### Userdata を選ぶべき時
* **Auto Scaling を使う場合**: 起動した瞬間にWebサーバーとして完成している必要があるため。
* **構築が非常にシンプルな場合**: 今回のように基本的なパッケージを数件入れるだけの構成。

### Ansible を選ぶべき時
* **サーバーを長く運用する場合**: OSのパッチ適用やミドルウェアの設定変更を継続的に行う必要がある。
* **複雑な構成**: DB、キャッシュ、Webサーバーなど、複数の役割のサーバーが密接に連携し、順序立てた構築が必要な場合。

---

## 5. まとめ
今回のハンズオンでは、**「最速でWordPress環境のインフラを立ち上げる」**ことを優先し、Terraformとの親和性が高く追加学習コストの低い **Userdata** を採用しました。
実務においては、**「TerraformでネットワークとOSを作成し、Ansibleで詳細な設定を流し込む」** という組み合わせが、柔軟性と保守性のバランスが取れた構成として広く採用されています。